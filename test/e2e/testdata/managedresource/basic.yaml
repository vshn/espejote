apiVersion: v1
kind: ServiceAccount
metadata:
  name: test-basic
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: test-basic
rules:
- apiGroups: [""]
  resources: ["configmaps"]
  verbs: ["*"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: test-basic
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: test-basic
subjects:
- kind: ServiceAccount
  name: test-basic
---
apiVersion: espejote.io/v1alpha1
kind: JsonnetLibrary
metadata:
  labels:
    app.kubernetes.io/name: espejote
    app.kubernetes.io/managed-by: kustomize
  name: test-basic
spec:
  data:
    sample.libsonnet: "'some sample string'"
---
apiVersion: espejote.io/v1alpha1
kind: ManagedResource
metadata:
  name: test-basic
spec:
  serviceAccountRef:
    name: test-basic
  context:
  - name: configmaps
    resource:
      apiVersion: v1
      kind: ConfigMap
      labelSelector:
        matchExpressions:
        - key: test-basic.espejote.io/duplicate-cm
          operator: Exists
  triggers:
  - name: configmap
    watchContextResource:
      name: configmaps
  template: |
    local esp = import "espejote.libsonnet";
    local samplelib = import "test-basic/sample.libsonnet";
    local configmaps = esp.context().configmaps;

    local duplicateCM = function(cm) {
      apiVersion: 'v1',
      kind: 'ConfigMap',
      metadata: {
        name: cm.metadata.name + '-duplicate',
      },
      data: cm.data {
        sample: samplelib,
      },
    };

    if esp.triggerName() == "configmap" then [
      duplicateCM(esp.triggerData().resource),
    ] else [
      duplicateCM(cm) for cm in configmaps
    ]
